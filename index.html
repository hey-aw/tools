<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Festivia Holiday Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: radial-gradient(circle at top, #12233b 0, #050814 55%, #02030a 100%);
      color: #f9fafb;
    }
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      padding: 1.5rem;
    }
    .app {
      max-width: 900px;
      width: 100%;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      padding: 1.75rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.7);
    }
    h1 { font-size: 1.6rem; display: flex; align-items: center; gap: .5rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media(max-width: 720px){ .grid { grid-template-columns: 1fr; } }
    label { display:block; margin-top:.5rem; opacity:.8; font-size:.75rem; }
    input {
      width:100%; padding:.5rem; border-radius:.5rem;
      border:1px solid rgba(55,65,81,.9); background:rgba(15,23,42,.9);
      color:white;
    }
    button {
      margin-top:.5rem; width:100%; padding:.4rem .6rem;
      border:none; border-radius:999px; cursor:pointer;
      background:#1f2937; color:white; font-size:.8rem;
    }
    button.primary { background:linear-gradient(135deg,#22c55e,#14b8a6); }
    button.danger  { background:linear-gradient(135deg,#f97316,#ef4444); }
    button.small { font-size:.75rem; padding:.3rem .5rem; }
    .panel { border:1px solid rgba(55,65,81,.9); padding:1rem; border-radius:16px; }
    .log {
      margin-top:.5rem; max-height:200px; overflow:auto;
      background:rgba(2,6,23,.9); border:1px solid rgba(55,65,81,.9);
      border-radius:.5rem; padding:.5rem; font-family:monospace;
      font-size:.75rem;
    }
    .status-bar {
      margin-top:.7rem; padding:.5rem; display:flex; gap:.5rem; align-items:center;
      border:1px solid rgba(55,65,81,.9); border-radius:8px;
      background:rgba(15,23,42,.9);
    }
    .status-pill {
      padding:.1rem .6rem; border-radius:999px; font-size:.7rem;
      border:1px solid rgba(148,163,184,.4);
    }
    .status-pill.ok { border-color:#6ee7b7; color:#6ee7b7; }
    .status-pill.err { border-color:#fecaca; color:#fecaca; }
    .status-pill.anim { border-color:#c7d2fe; color:#c7d2fe; }
  </style>
</head>
<body>
<div class="app">
  <h1>üéÑ Festivia Holiday Controller</h1>

  <div class="grid">
    <!-- LEFT PANEL -->
    <div class="panel">
      <h2>üîå Bridge Connection</h2>

      <label>Bridge IP</label>
      <input id="bridgeIp" placeholder="Auto-detect or enter manually" />

      <button id="discoverBridgeBtn" class="small">üîç Auto-Discover Hue Bridge</button>

      <label>API Key</label>
      <input id="apiKey" placeholder="Hue API key" />

      <label>Selected Light ID</label>
      <input id="lightId" placeholder="Auto-select after scanning" />

      <button id="testBtn" class="primary small">Test Connection</button>
      <button id="listLightsBtn" class="small">üí° List Lights</button>

      <!-- LIGHT LIST -->
      <div id="lightsList" style="
        margin-top: 0.5rem; padding: 0.5rem; display:none;
        background:rgba(2,6,23,.85); border-radius:.5rem;
        border:1px solid rgba(55,65,81,.7); max-height:230px; overflow-y:auto;
      "></div>

      <div class="status-bar">
        <span id="statusMode" class="status-pill">IDLE</span>
        <span id="statusText" style="flex:1;">Ready.</span>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel">
      <h2>üéÜ Animations</h2>

      <button class="primary small anim-btn" data-anim="candyCane">üç¨ Candy Cane</button>
      <button class="primary small anim-btn" data-anim="aurora">üåå Aurora</button>
      <button class="primary small anim-btn" data-anim="snowfall">‚ùÑÔ∏è Snowfall</button>
      <button class="primary small anim-btn" data-anim="fireplace">üî• Fireplace</button>

      <button id="stopAnimBtn" class="danger small">‚èπ Stop Animations</button>

      <div id="log" class="log"></div>
    </div>
  </div>
</div>

<script>
/* -------------------------- LOG + STATUS -------------------------- */

function log(msg){
  const el=document.getElementById("log");
  el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  el.scrollTop = el.scrollHeight;
}

function setStatus(mode, text, kind){
  const m=document.getElementById("statusMode");
  const t=document.getElementById("statusText");

  m.textContent = mode.toUpperCase();
  t.textContent = text;

  m.className = "status-pill";
  if(kind==="ok") m.classList.add("ok");
  if(kind==="err") m.classList.add("err");
  if(kind==="anim") m.classList.add("anim");
}

/* -------------------------- API HELPERS --------------------------- */

function baseUrl(){
  return `http://${document.getElementById("bridgeIp").value}/api/${document.getElementById("apiKey").value}`;
}

async function hueGet(path){
  log("GET " + path);
  const res = await fetch(baseUrl() + path);
  return { data: await res.json(), res };
}

async function huePut(path, body){
  log("PUT " + path + " " + JSON.stringify(body));
  const res = await fetch(baseUrl() + path, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  return { data: await res.json(), res };
}

/* -------------------------- AUTO DISCOVER BRIDGE --------------------------- */

document.getElementById("discoverBridgeBtn").addEventListener("click", async()=>{
  try{
    setStatus("search","Finding bridge‚Ä¶");

    const res = await fetch("https://discovery.meethue.com");
    const bridges = await res.json();

    if(!bridges.length){
      setStatus("error","No bridge found", "err");
      return;
    }

    const ip = bridges[0].internalipaddress;
    document.getElementById("bridgeIp").value = ip;

    setStatus("ok", `Bridge found at ${ip}`, "ok");
    log("Bridge discovered: "+ip);
  } catch(err){
    setStatus("error", err.message, "err");
  }
});

/* -------------------------- TEST LIGHT --------------------------- */

document.getElementById("testBtn").addEventListener("click", async()=>{
  try{
    const id = document.getElementById("lightId").value;
    const {data,res}=await hueGet(`/lights/${id}`);

    if(!res.ok){
      setStatus("error","Light not found","err");
      return;
    }

    setStatus("ok",`Connected to ${data.name}`,"ok");
  }catch(err){
    setStatus("error",err.message,"err");
  }
});

/* -------------------------- LIST + AUTO-DETECT FESTIVIA -------------------------- */

document.getElementById("listLightsBtn").addEventListener("click", async ()=>{
  try{
    setStatus("loading","Fetching lights‚Ä¶");

    const {data,res} = await hueGet("/lights");

    if(!res.ok){
      setStatus("error","Could not get lights","err");
      return;
    }

    const container = document.getElementById("lightsList");
    container.innerHTML = "";
    container.style.display = "block";

    for(const id in data){
      const light = data[id];
      const isFestivia = (light.modelid || "").startsWith("LCX");
      const badge = isFestivia ? ` <span style="color:#facc15;">‚òÖ Festivia</span>` : "";

      const row=document.createElement("div");
      row.style.padding=".4rem";
      row.style.cursor="pointer";
      row.style.borderBottom="1px solid rgba(255,255,255,.08)";

      row.innerHTML = `
        <strong style="color:#93c5fd;">#${id}</strong> ‚Äî ${light.name}${badge}<br>
        <span style="opacity:.7;">${light.type}</span>
      `;

      row.addEventListener("click",()=>{
        document.getElementById("lightId").value=id;
        setStatus("ok",`Selected Light #${id} (${light.name})`,"ok");
      });

      container.appendChild(row);

      if(isFestivia){
        document.getElementById("lightId").value=id;
        setStatus("ok",`Auto-selected Festivia #${id}`,"ok");
      }
    }

    setStatus("ok","Lights loaded. Click one to select.","ok");
  }catch(err){
    setStatus("error",err.message,"err");
  }
});

/* -------------------------- ANIMATIONS -------------------------- */

let timer=null;

const Anim={
  candyCane:step=>huePut(`/lights/${lightId.value}/state`,
    {on:true,bri:200,sat:step%2?10:254,hue:step%2?40000:0,transitiontime:2}),
  aurora:step=>huePut(`/lights/${lightId.value}/state`,
    {on:true,bri:170,sat:254,hue:[15000,25000,35000,45000,55000][step%5],transitiontime:3}),
  snowfall:step=>huePut(`/lights/${lightId.value}/state`,
    {on:true,bri:200+(Math.random()*40-20),sat:20,hue:42000,transitiontime:2}),
  fireplace:step=>huePut(`/lights/${lightId.value}/state`,
    {on:true,bri:180+(Math.random()*60-30),sat:230,hue:9000+(Math.random()*4000-2000),transitiontime:2})
};

document.querySelectorAll(".anim-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const key=btn.dataset.anim;
    if(timer)clearInterval(timer);

    let step=0;
    timer=setInterval(()=>Anim[key](step++),800);

    setStatus("anim",`Running ${key}`,"anim");
  });
});

document.getElementById("stopAnimBtn").addEventListener("click",()=>{
  if(timer)clearInterval(timer);
  setStatus("idle","Animations stopped");
});
</script>
</body>
</html>
