<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hue v2 Festivia Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      background: #0a0f1a;
      color: #eef;
      font-family: system-ui, sans-serif;
      margin: 0; padding: 1.5rem;
    }
    h1 { font-size: 1.6rem; margin-bottom: .3rem; }
    h2 { font-size: 1.1rem; margin-top: 1.2rem; }
    input, button {
      width: 100%;
      padding: .6rem;
      margin-top: .4rem;
      border-radius: .4rem;
      border: 1px solid #334;
      background: #111a2b;
      color: #eef;
    }
    button { cursor: pointer; background: #223b72; }
    button:hover { background: #3050a0; }
    .panel {
      border: 1px solid #334;
      padding: 1rem;
      border-radius: .6rem;
      margin-top: 1rem;
      background: rgba(20,30,55,0.7);
    }
    #lightsList div {
      padding: .4rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
    }
    .log {
      margin-top: .5rem;
      padding: .5rem;
      background: #0005;
      height: 150px;
      overflow-y: auto;
      font-size: .75rem;
      border-radius: .4rem;
    }
  </style>
</head>

<body>
<h1>ğŸ„ Festivia Hue Controller (v2 API)</h1>

<div class="panel">
  <h2>Bridge Connection</h2>

  <label>Bridge IP</label>
  <input id="bridgeIp" placeholder="192.168.x.x">

  <button id="discoverBtn">ğŸ” Auto-Discover Bridge</button>

  <label>API Key</label>
  <input id="apiKey" placeholder="Hue App Key">

  <label>Selected Light UUID</label>
  <input id="lightId">

  <button id="listLights">ğŸ’¡ List Lights (v2)</button>

  <div id="lightsList" style="display:none; margin-top:1rem;"></div>
</div>

<div class="panel">
  <h2>Festivia Effects (v2)</h2>

  <button onclick="sparkle()">âœ¨ Sparkle</button>
  <button onclick="twinkle()">ğŸŒŸ Twinkle</button>
  <button onclick="candle()">ğŸ•¯ Candle</button>
  <button onclick="fire()">ğŸ”¥ Fire</button>
  <button onclick="glisten()">ğŸŒŒ Glisten</button>

  <h2>Custom Gradient Animations</h2>

  <button onclick="rainbow()">ğŸŒˆ Rainbow Loop</button>
  <button onclick="candyCane()">ğŸ¬ Candy Cane</button>
  <button onclick="aurora()">ğŸŒŒ Aurora</button>
  <button onclick="fireplace()">ğŸ”¥ Fireplace Glow</button>

</div>

<div class="log" id="log"></div>

<script>
/* -------------------------------------------------------
   Logging
------------------------------------------------------- */
function log(msg) {
  const el = document.getElementById("log");
  el.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
  el.scrollTop = el.scrollHeight;
}

/* -------------------------------------------------------
   Hue API v2 helper
------------------------------------------------------- */
function hueV2(path, method = "GET", body = null) {
  const ip = document.getElementById("bridgeIp").value;
  const key = document.getElementById("apiKey").value;

  return fetch(`http://${ip}/clip/v2/resource/${path}`, {
    method,
    headers: {
      "hue-application-key": key,
      "Content-Type": "application/json"
    },
    body: body ? JSON.stringify(body) : null
  }).then(r => r.json());
}

/* -------------------------------------------------------
  Bridge Discovery
------------------------------------------------------- */
document.getElementById("discoverBtn").onclick = async () => {
  const res = await fetch("https://discovery.meethue.com");
  const bridges = await res.json();
  if (bridges.length) {
    document.getElementById("bridgeIp").value = bridges[0].internalipaddress;
    log("Bridge found: " + bridges[0].internalipaddress);
  } else {
    log("No bridge found");
  }
};

/* -------------------------------------------------------
   List v2 Lights
------------------------------------------------------- */
document.getElementById("listLights").onclick = async () => {
  const result = await hueV2("light");
  const list = document.getElementById("lightsList");
  list.style.display = "block";
  list.innerHTML = "";

  result.data.forEach(light => {
    const id = light.id;
    const model = light.product_data.model_id;
    const name = light.metadata.name;
    const isFestivia = model.startsWith("LCX");

    const row = document.createElement("div");
    row.innerHTML = `<strong>${name}</strong> (${model}) ${isFestivia ? "ğŸŒŸ Festivia" : ""}<br>${id}`;
    row.onclick = () => {
      document.getElementById("lightId").value = id;
      log("Selected " + name);
    };

    list.appendChild(row);

    if (isFestivia) {
      document.getElementById("lightId").value = id;
      log("Auto-selected Festivia " + name);
    }
  });

  log("Lights loaded");
};

/* -------------------------------------------------------
   FESTIVIA v2 BUILT-IN EFFECTS
------------------------------------------------------- */
function effect(name) {
  const id = document.getElementById("lightId").value;
  hueV2(`light/${id}`, "PUT", {
    effect: { effect: name }
  }).then(r => log("Effect: " + name));
}

const sparkle = () => effect("sparkle");
const twinkle = () => effect("twinkle");
const candle  = () => effect("candle");
const fire    = () => effect("fire");
const glisten = () => effect("glisten");

/* -------------------------------------------------------
   CUSTOM GRADIENTS
------------------------------------------------------- */
function setGradient(points) {
  const id = document.getElementById("lightId").value;

  hueV2(`light/${id}`, "PUT", {
    color: {
      gradient: {
        mode: "loop",
        points
      }
    }
  }).then(r => log("Gradient updated"));
}

function rainbow() {
  setGradient([
    { color: { xy: [0.7, 0.3] }},
    { color: { xy: [0.17, 0.7] }},
    { color: { xy: [0.4, 0.5] }}
  ]);
}

function candyCane() {
  setGradient([
    { color: { xy: [0.68, 0.32] }},  // red
    { color: { xy: [0.32, 0.33] }}   // white
  ]);
}

function aurora() {
  setGradient([
    { color: { xy: [0.17, 0.7] }},
    { color: { xy: [0.28, 0.23] }},
    { color: { xy: [0.1, 0.1] }}
  ]);
}

function fireplace() {
  setGradient([
    { color: { xy: [0.6, 0.38] }},   // amber
    { color: { xy: [0.67, 0.32] }}    // deep red
  ]);
}
</script>

</body>
</html>
